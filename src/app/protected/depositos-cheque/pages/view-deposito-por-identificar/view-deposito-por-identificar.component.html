<div class="surface-section p-3">
    <div class="card border-1 surface-border shadow-2">
        <!-- Header -->
        <div class="surface-section border-bottom-1 surface-border p-4">
            <div class="flex align-items-center">
                <i class="pi pi-money-bill text-600 text-2xl mr-3"></i>
                <div>
                    <h2 class="text-900 font-semibold text-xl m-0">Depósitos por Identificar</h2>
                    <span class="text-600 text-sm mt-1 block">Busque y visualice los depósitos pendientes por identificar</span>
                </div>
            </div>
        </div>
        
        <!-- Search Form Panel - Only date criteria -->
        <div class="surface-section p-4 border-bottom-1 surface-border">
            <div class="text-900 font-medium text-lg mb-5">Criterios de Búsqueda</div>
            
            <div class="p-fluid formgrid grid">
                <!-- Fecha Inicio Field -->
                <div class="field col-12 md:col-4 lg:col-3 mb-3">
                    <span class="p-float-label">
                        <p-calendar id="fechaInicio" 
                                   [(ngModel)]="fechaInicio" 
                                   dateFormat="dd/mm/yy" 
                                   [showIcon]="true"
                                   [disabled]="loading"
                                   styleClass="w-full"></p-calendar>
                        <label for="fechaInicio">Desde</label>
                    </span>
                </div>
                
                <!-- Fecha Fin Field -->
                <div class="field col-12 md:col-4 lg:col-3 mb-3">
                    <span class="p-float-label">
                        <p-calendar id="fechaFin" 
                                   [(ngModel)]="fechaFin" 
                                   dateFormat="dd/mm/yy" 
                                   [showIcon]="true"
                                   [disabled]="loading"
                                   styleClass="w-full"></p-calendar>
                        <label for="fechaFin">Hasta</label>
                    </span>
                </div>
                
                <!-- Search Button -->
                <div class="field col-12 md:col-4 lg:col-6 mb-3 flex align-items-end">
                    <p-button label="Buscar" 
                             icon="pi pi-search" 
                             styleClass="w-auto ml-auto" 
                             [loading]="loading"
                             (onClick)="buscar()"></p-button>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="surface-section p-4">
            <!-- Results Header -->
            <div class="flex align-items-center justify-content-between mb-3">
                <div class="text-900 font-medium text-lg">Resultados</div>
                <div class="flex align-items-center gap-2">
                    <p-button *ngIf="depositos.length > 0"
                             icon="pi pi-file-pdf" 
                             label="Exportar PDF" 
                             styleClass="p-button-outlined p-button-sm" 
                             (onClick)="exportarPDF()"
                             pTooltip="Exportar resultados a PDF"></p-button>
                    <span *ngIf="depositos.length > 0" class="text-600 text-sm">
                        {{depositos.length}} registros encontrados
                    </span>
                </div>
            </div>
            
            <!-- Results Table - Modified to show only specific columns -->
            <p-table [value]="depositos" 
                     [loading]="loading" 
                     styleClass="p-datatable-sm" 
                     [paginator]="true" 
                     [rows]="10" 
                     [rowsPerPageOptions]="[5,10,25,50]"
                     [showCurrentPageReport]="true"
                     currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} depósitos"
                     [rowHover]="true"
                     responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="idDeposito" style="width: 70px">ID <p-sortIcon field="idDeposito"></p-sortIcon></th>
                        <th pSortableColumn="codCliente">Cliente <p-sortIcon field="codCliente"></p-sortIcon></th>
                        <th pSortableColumn="nombreEmpresa">Empresa <p-sortIcon field="nombreEmpresa"></p-sortIcon></th>
                        <th pSortableColumn="nombreBanco">Banco <p-sortIcon field="nombreBanco"></p-sortIcon></th>
                        <th pSortableColumn="importe">Importe <p-sortIcon field="importe"></p-sortIcon></th>
                        <th pSortableColumn="moneda" style="width: 100px">Moneda <p-sortIcon field="moneda"></p-sortIcon></th>
                        <th pSortableColumn="fechaI">Fecha <p-sortIcon field="fechaI"></p-sortIcon></th>
                        <th pSortableColumn="obs">Observaciones <p-sortIcon field="obs"></p-sortIcon></th>
                        <th style="width: 150px">Acciones</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-deposito>
                    <tr>
                        <td>{{deposito.idDeposito}}</td>
                        <td>
                            <span class="text-900">{{deposito.codCliente}}</span>
                        </td>
                        <td>{{deposito.nombreEmpresa}}</td>
                        <td>{{deposito.nombreBanco}}</td>
                        <td>{{deposito.importe | number }}</td>
                        <td>{{deposito.moneda}}</td>
                        <td>{{deposito.fechaI | date:'dd/MM/yyyy'}}</td>
                        <td>{{deposito.obs}}</td>
                        <td>
                            <div class="flex gap-2 justify-content-center">
                                <button pButton pRipple 
                                        type="button"
                                        icon="pi pi-user-edit" 
                                        class="p-button-text p-button-sm p-button-warning" 
                                        (click)="abrirDialogoActualizarCliente(deposito)" 
                                        pTooltip="Actualizar Cliente"></button>
                                <button pButton pRipple 
                                        type="button"
                                        icon="pi pi-image" 
                                        class="p-button-text p-button-sm" 
                                        (click)="descargarImagen(deposito)" 
                                        pTooltip="Descargar Imagen"></button>
                                <button pButton pRipple 
                                        type="button"
                                        icon="pi pi-file-pdf" 
                                        class="p-button-text p-button-sm" 
                                        (click)="descargarPdf(deposito)" 
                                        pTooltip="Descargar PDF"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7">
                            <div class="flex flex-column align-items-center p-4">
                                <i class="pi pi-search text-400 text-3xl mb-3"></i>
                                <span class="text-700">No se encontraron depósitos por identificar</span>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="loadingbody">
                    <tr>
                        <td colspan="7">
                            <div class="flex justify-content-center align-items-center p-3">
                                <i class="pi pi-spin pi-spinner mr-2"></i>
                                <span>Cargando datos...</span>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>

<!-- Diálogo para actualizar cliente -->
<p-dialog header="Actualizar Cliente" [(visible)]="mostrarDialogoCliente" [style]="{width: '500px'}" 
          [modal]="true" [closable]="true" [closeOnEscape]="true" [dismissableMask]="false">
    <div class="p-fluid">
        <!-- Información del depósito (solo lectura) -->
        <div class="card mb-3">
            <h5 class="text-lg font-medium text-800 mb-3">Información del Depósito</h5>
            <div class="grid">
                <div class="col-6 mb-2">
                    <label class="block text-sm font-medium text-700 mb-1">ID Depósito</label>
                    <div class="p-inputtext p-component p-filled bg-gray-100 text-md">
                        {{depositoSeleccionado?.idDeposito || '-'}}
                    </div>
                </div>
                
                <div class="col-6 mb-2">
                    <label class="block text-sm font-medium text-700 mb-1">Banco</label>
                    <div class="p-inputtext p-component p-filled bg-gray-100 text-md">
                        {{depositoSeleccionado?.nombreBanco || '-'}}
                    </div>
                </div>
                
                <div class="col-6 mb-2">
                    <label class="block text-sm font-medium text-700 mb-1">Importe</label>
                    <div class="p-inputtext p-component p-filled bg-gray-100 text-md">
                        {{depositoSeleccionado?.importe | number}} {{depositoSeleccionado?.moneda}}
                    </div>
                </div>
                
                <div class="col-6 mb-2">
                    <label class="block text-sm font-medium text-700 mb-1">Fecha</label>
                    <div class="p-inputtext p-component p-filled bg-gray-100 text-md">
                        {{depositoSeleccionado?.fechaI | date:'dd/MM/yyyy'}}
                    </div>
                </div>
                
                <div class="col-12 mb-2">
                    <label class="block text-sm font-medium text-700 mb-1">Observaciones</label>
                    <div class="p-inputtext p-component p-filled bg-gray-100 text-md" style="min-height: 40px">
                        {{depositoSeleccionado?.obs || 'Sin observaciones'}}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Campos editables -->
        <h5 class="text-lg font-medium text-800 mb-3">Asignar Cliente</h5>
        
        <div class="field mb-4">
            <label for="empresa" class="font-medium text-900">Empresa</label>
            <p-dropdown id="empresa" [(ngModel)]="empresaSeleccionada" 
                       [options]="empresas" optionLabel="nombre" optionValue="codEmpresa"
                       placeholder="Seleccione una empresa" [disabled]="cargandoClientes"
                       (onChange)="cargarClientesPorEmpresa($event)" styleClass="w-full"></p-dropdown>
        </div>
        
        <div class="field mb-4">
            <label for="cliente" class="font-medium text-900">Cliente</label>
            <p-dropdown id="cliente" [(ngModel)]="clienteSeleccionado" 
                       [options]="clientes" optionLabel="nombreCompleto" optionValue="codCliente"
                       placeholder="Seleccione un cliente" [disabled]="cargandoClientes"
                       [filter]="true" filterBy="nombreCompleto" styleClass="w-full"></p-dropdown>
            <small *ngIf="cargandoClientes" class="text-primary">
                <i class="pi pi-spin pi-spinner mr-1"></i>Cargando clientes...
            </small>
        </div>
    </div>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
                class="p-button-text" (click)="mostrarDialogoCliente = false"></button>
        <button pButton pRipple label="Guardar" icon="pi pi-check" 
                class="p-button-text" [loading]="guardandoCliente"
                (click)="actualizarCliente()" [disabled]="!clienteSeleccionado"></button>
    </ng-template>
</p-dialog>

<!-- Toast messages -->
<p-toast position="top-right"></p-toast>
